<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Analysis Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="chat_ui.css">
</head>
<body>
    <div id="root"></div>

    <script>
        const { useState, useRef, useEffect } = React;

        // Configure marked for rendering markdown
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        function FinanceChatUI() {
            const [messages, setMessages] = useState([{
                role: 'assistant',
                content: 'Hi! I am your financial analysis assistant. How can I help you today?',
                timestamp: new Date()
            }]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [toolModel, setToolModel] = useState('granite4:350m');
            const [chatModel, setChatModel] = useState('granite4:1b');
            const [showSettings, setShowSettings] = useState(false);
            const [apiUrl, setApiUrl] = useState('http://localhost:8000');
            const messagesEndRef = useRef(null);

            const models = [
                { value: 'granite4:350m', label: 'Granite 350M' },
                { value: 'granite4:350m-h', label: 'Granite 350M H' },
                { value: 'granite4:1b', label: 'Granite 1B' },
                { value: 'granite4:1b-h', label: 'Granite 1B H' },
                { value: 'granite4:3b', label: 'Granite 3B' },
                { value: 'granite4:3b-h', label: 'Granite 3B H' }
            ];

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const getToolIcon = (toolName) => {
                const icons = {
                    'get_key_financial_metrics': 'ðŸ“ˆ',
                    'get_balance_sheet': 'ðŸ“„',
                    'get_dividends': 'ðŸ’°',
                    'get_latest_news': 'ðŸ“°'
                };
                return icons[toolName] || 'ðŸ”§';
            };

            const handleSubmit = async () => {
                if (!input.trim() || isLoading) return;

                const userMessage = {
                    role: 'user',
                    content: input,
                    timestamp: new Date()
                };

                setMessages(prev => [...prev, userMessage]);
                const currentInput = input;
                setInput('');
                setIsLoading(true);

                try {
                    const response = await fetch(`${apiUrl}/agent/trading/chat/stream`, {
                        method: 'POST',
                        headers: {
                            'accept': 'text/plain',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            tool_model: toolModel,
                            chat_model: chatModel,
                            prompt: currentInput
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    let assistantMessageIndex = null;

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('data: ');
                        
                        // Keep the last incomplete line in the buffer
                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            if (!line.trim()) continue;
                            
                            try {
                                const data = JSON.parse(line.trim());

                                if (data.type === 'tool') {
                                    // Hide loading indicator when first data arrives
                                    setIsLoading(false);
                                    
                                    setMessages(prev => [...prev, {
                                        role: 'tool',
                                        toolName: data.name,
                                        content: typeof data.args === 'string' ? data.args : JSON.stringify(data.args, null, 2),
                                        timestamp: new Date()
                                    }]);
                                } else if (data.type === 'text') {
                                    // Hide loading indicator when first text arrives
                                    setIsLoading(false);
                                    
                                    if (assistantMessageIndex === null) {
                                        // Create new assistant message
                                        setMessages(prev => {
                                            assistantMessageIndex = prev.length;
                                            return [...prev, {
                                                role: 'assistant',
                                                content: data.content || '',
                                                timestamp: new Date()
                                            }];
                                        });
                                    } else {
                                        // Append to existing assistant message
                                        setMessages(prev => {
                                            const newMessages = [...prev];
                                            if (newMessages[assistantMessageIndex]) {
                                                newMessages[assistantMessageIndex].content += (data.content || '');
                                            }
                                            return newMessages;
                                        });
                                    }
                                } else if (data.type === 'done') {
                                    setIsLoading(false);
                                }
                            } catch (e) {
                                console.error('Error parsing stream data:', e, 'Line:', line);
                            }
                        }
                    }

                } catch (error) {
                    console.error('Error calling API:', error);
                    const errorMessage = {
                        role: 'assistant',
                        content: `Error: ${error.message}. Make sure your FastAPI server is running at ${apiUrl} with CORS enabled.`,
                        timestamp: new Date()
                    };
                    setMessages(prev => [...prev, errorMessage]);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSubmit();
                }
            };

            return React.createElement('div', {
                className: 'flex flex-col h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900'
            },
                // Header
                React.createElement('div', {
                    className: 'bg-slate-800/50 backdrop-blur-sm border-b border-slate-700 p-4 shadow-lg'
                },
                    React.createElement('div', { className: 'max-w-4xl mx-auto' },
                        React.createElement('div', { className: 'flex items-center justify-between mb-3' },
                            React.createElement('div', { className: 'flex items-center gap-3' },
                                React.createElement('div', { className: 'bg-gradient-to-br from-blue-500 to-cyan-500 p-2 rounded-lg' }, 'ðŸ“Š'),
                                React.createElement('div', null,
                                    React.createElement('h1', { className: 'text-xl font-bold text-white' }, 'Financial Analysis Assistant'),
                                    React.createElement('p', { className: 'text-sm text-slate-400' }, 'Powered by Granite LLM')
                                )
                            ),
                            React.createElement('button', {
                                onClick: () => setShowSettings(!showSettings),
                                className: 'p-2 hover:bg-slate-700 rounded-lg transition-colors text-slate-400'
                            }, 'âš™ï¸')
                        ),
                        showSettings && React.createElement('div', {
                            className: 'bg-slate-900/50 border border-slate-700 rounded-lg p-4 space-y-3'
                        },
                            React.createElement('div', null,
                                React.createElement('label', { className: 'text-sm text-slate-400 block mb-1' }, 'API URL'),
                                React.createElement('input', {
                                    type: 'text',
                                    value: apiUrl,
                                    onChange: (e) => setApiUrl(e.target.value),
                                    className: 'w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500',
                                    placeholder: 'http://127.0.0.1:8000'
                                })
                            ),
                            React.createElement('div', { className: 'grid grid-cols-2 gap-3' },
                                React.createElement('div', null,
                                    React.createElement('label', { className: 'text-sm text-slate-400 block mb-1' }, 'Tool Selection Model'),
                                    React.createElement('select', {
                                        value: toolModel,
                                        onChange: (e) => setToolModel(e.target.value),
                                        className: 'w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500'
                                    }, models.map(model => React.createElement('option', { key: model.value, value: model.value }, model.label)))
                                ),
                                React.createElement('div', null,
                                    React.createElement('label', { className: 'text-sm text-slate-400 block mb-1' }, 'Chat Response Model'),
                                    React.createElement('select', {
                                        value: chatModel,
                                        onChange: (e) => setChatModel(e.target.value),
                                        className: 'w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500'
                                    }, models.map(model => React.createElement('option', { key: model.value, value: model.value }, model.label)))
                                )
                            ),
                            React.createElement('div', { className: 'text-xs text-slate-500' },
                                `Tool Model: ${toolModel} | Chat Model: ${chatModel}`
                            )
                        )
                    )
                ),
                // Messages
                React.createElement('div', { className: 'flex-1 overflow-y-auto p-4' },
                    React.createElement('div', { className: 'max-w-4xl mx-auto space-y-4' },
                        messages.map((msg, idx) =>
                            React.createElement('div', {
                                key: idx,
                                className: `flex gap-3 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`
                            },
                                msg.role !== 'user' && React.createElement('div', {
                                    className: `flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-lg ${
                                        msg.role === 'tool' 
                                            ? 'bg-gradient-to-br from-purple-500 to-pink-500' 
                                            : 'bg-gradient-to-br from-blue-500 to-cyan-500'
                                    }`
                                }, msg.role === 'tool' ? getToolIcon(msg.toolName) : 'ðŸ¤–'),
                                React.createElement('div', { className: `max-w-2xl ${msg.role === 'user' ? 'order-first' : ''}` },
                                    React.createElement('div', {
                                        className: `rounded-2xl px-4 py-3 ${
                                            msg.role === 'user' 
                                                ? 'bg-gradient-to-br from-blue-600 to-cyan-600 text-white ml-auto' 
                                                : msg.role === 'tool'
                                                ? 'bg-purple-500/10 border border-purple-500/20 text-purple-300'
                                                : 'bg-slate-800/50 border border-slate-700 text-slate-200'
                                        }`
                                    },
                                        msg.role === 'tool' && React.createElement('div', {
                                            className: 'text-xs font-semibold mb-1 text-purple-400'
                                        }, `ðŸ”§ Tool: ${msg.toolName}`),
                                        msg.role === 'assistant' 
                                            ? React.createElement('div', { 
                                                className: 'markdown-content',
                                                dangerouslySetInnerHTML: { __html: marked.parse(msg.content || '') }
                                            })
                                            : React.createElement('p', { className: 'whitespace-pre-wrap' }, msg.content),
                                        React.createElement('div', {
                                            className: `text-xs mt-1 ${msg.role === 'user' ? 'text-blue-200' : 'text-slate-500'}`
                                        }, msg.timestamp.toLocaleTimeString())
                                    )
                                ),
                                msg.role === 'user' && React.createElement('div', {
                                    className: 'flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center text-lg'
                                }, 'ðŸ‘¤')
                            )
                        ),
                        isLoading && React.createElement('div', { className: 'flex gap-3 justify-start' },
                            React.createElement('div', {
                                className: 'flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-lg'
                            }, 'ðŸ¤–'),
                            React.createElement('div', { className: 'bg-slate-800/50 border border-slate-700 rounded-2xl px-4 py-3' },
                                React.createElement('div', { className: 'flex gap-1' },
                                    React.createElement('div', { className: 'w-2 h-2 bg-slate-500 rounded-full animate-bounce', style: { animationDelay: '0ms' } }),
                                    React.createElement('div', { className: 'w-2 h-2 bg-slate-500 rounded-full animate-bounce', style: { animationDelay: '150ms' } }),
                                    React.createElement('div', { className: 'w-2 h-2 bg-slate-500 rounded-full animate-bounce', style: { animationDelay: '300ms' } })
                                )
                            )
                        ),
                        React.createElement('div', { ref: messagesEndRef })
                    )
                ),
                // Input
                React.createElement('div', { className: 'border-t border-slate-700 bg-slate-800/50 backdrop-blur-sm p-4' },
                    React.createElement('div', { className: 'max-w-4xl mx-auto' },
                        React.createElement('div', { className: 'flex gap-2' },
                            React.createElement('input', {
                                type: 'text',
                                value: input,
                                onChange: (e) => setInput(e.target.value),
                                onKeyPress: handleKeyPress,
                                placeholder: 'Ask about stocks, financials, dividends...',
                                className: 'flex-1 bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500',
                                disabled: isLoading
                            }),
                            React.createElement('button', {
                                onClick: handleSubmit,
                                disabled: isLoading || !input.trim(),
                                className: 'bg-gradient-to-br from-blue-600 to-cyan-600 text-white rounded-xl px-6 py-3 font-medium hover:from-blue-700 hover:to-cyan-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all'
                            }, 'ðŸ“¤')
                        )
                    )
                )
            );
        }

        ReactDOM.render(React.createElement(FinanceChatUI), document.getElementById('root'));
    </script>
</body>
</html>